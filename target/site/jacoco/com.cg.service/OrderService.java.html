<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">20-SpringBoot-Hello</a> &gt; <a href="index.source.html" class="el_package">com.cg.service</a> &gt; <span class="el_source">OrderService.java</span></div><h1>OrderService.java</h1><pre class="source lang-java linenums">package com.cg.service;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.crossstore.ChangeSetPersister.NotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.cg.dto.OrderDto;
import com.cg.entity.DeliveryAgent;
import com.cg.entity.Order;
import com.cg.entity.Payment;
import com.cg.enumeration.OrderStatus;
import com.cg.iservice.IOrderService;
import com.cg.mapper.OrderMapper;
import com.cg.repository.CustomerRepository;
import com.cg.repository.DeliveryAgentRepository;
import com.cg.repository.MenuItemRepository;
import com.cg.repository.OrderRepository;
import com.cg.entity.MenuItem;

@Service
<span class="fc" id="L30">public class OrderService implements IOrderService {</span>

	@Autowired
	private OrderRepository orderRepository;

	@Autowired
	private DeliveryAgentRepository deliveryAgentRepository;

	@Autowired
	private CustomerRepository customerRepository;

	@Autowired
	private MenuItemRepository menuItemRepository;

	// PLACE ORDER
	@Override
	@Transactional
	public OrderDto place(OrderDto dto) {
<span class="fc" id="L48">		Order entity = new Order();</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">		entity.setOrderStatus(dto.getOrderStatus() != null ? dto.getOrderStatus() : OrderStatus.PLACED);</span>
<span class="fc" id="L50">		entity.setOrderDate(LocalDateTime.now());</span>
<span class="fc" id="L51">		entity.setTotalAmount(dto.getTotalAmount());</span>

		// Set customer
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">		if (dto.getCustomerId() != null) {</span>
<span class="nc" id="L55">			customerRepository.findById(dto.getCustomerId()).ifPresent(entity::setCustomer);</span>
		}

		// Add items from itemIds (duplicates represent quantity)
<span class="pc bpc" id="L59" title="2 of 4 branches missed.">		if (dto.getItemIds() != null &amp;&amp; !dto.getItemIds().isEmpty()) {</span>
<span class="fc" id="L60">			List&lt;MenuItem&gt; itemsToAdd = new ArrayList&lt;&gt;();</span>

			// Load unique items once
<span class="fc" id="L63">			List&lt;MenuItem&gt; allItems = menuItemRepository.findAllById(dto.getItemIds());</span>
<span class="fc" id="L64">			Map&lt;Long, MenuItem&gt; itemById = allItems.stream().collect(Collectors.toMap(MenuItem::getItemId, it -&gt; it));</span>

			// Rebuild with duplicates
<span class="fc bfc" id="L67" title="All 2 branches covered.">			for (Long itemId : dto.getItemIds()) {</span>
<span class="fc" id="L68">				MenuItem item = itemById.get(itemId);</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">				if (item != null) {</span>
<span class="fc" id="L70">					itemsToAdd.add(item);</span>
				}
<span class="fc" id="L72">			}</span>
<span class="fc" id="L73">			entity.setItems(itemsToAdd);</span>
		}

<span class="fc" id="L76">		Order saved = orderRepository.save(entity);</span>
<span class="fc" id="L77">		return OrderMapper.toDto(saved);</span>
	}

	// UPDATE STATUS (Agent assignment fixed)

	@Override
	@Transactional
	public OrderDto updateStatus(Long orderId) {
<span class="pc" id="L85">		Order order = orderRepository.findById(orderId).orElseThrow(() -&gt; new RuntimeException(&quot;Order not found&quot;));</span>

<span class="pc bpc" id="L87" title="3 of 5 branches missed.">		switch (order.getOrderStatus()) {</span>

		case PLACED -&gt; {
<span class="fc" id="L90">			order.setOrderStatus(OrderStatus.PREPARING);</span>
<span class="fc" id="L91">			orderRepository.saveAndFlush(order);</span>
<span class="fc" id="L92">		}</span>

		case PREPARING -&gt; {
			// Pick an available agent
<span class="fc" id="L96">			DeliveryAgent agent = deliveryAgentRepository.findFirstByAvailabilityTrue()</span>
<span class="pc" id="L97">					.orElseThrow(() -&gt; new RuntimeException(&quot;No agents available&quot;));</span>

			// Reserve agent
<span class="nc" id="L100">			agent.setAvailability(false);</span>
<span class="nc" id="L101">			deliveryAgentRepository.save(agent);</span>

			// Assign to this order and change status to PICKED_UP
<span class="nc" id="L104">			order.setDeliveryAgent(agent);</span>
<span class="nc" id="L105">			order.setOrderStatus(OrderStatus.PICKED_UP);</span>

			// Persist both changes atomically
<span class="nc" id="L108">			orderRepository.saveAndFlush(order);</span>
<span class="nc" id="L109">		}</span>

		case PICKED_UP -&gt; {
<span class="nc" id="L112">			order.setOrderStatus(OrderStatus.OUT_FOR_DELIVERY);</span>
<span class="nc" id="L113">			orderRepository.saveAndFlush(order);</span>
<span class="nc" id="L114">		}</span>

		case OUT_FOR_DELIVERY -&gt; {
<span class="nc" id="L117">			order.setOrderStatus(OrderStatus.DELIVERED);</span>

			// Handle Cash on Delivery Payment
<span class="nc bnc" id="L120" title="All 2 branches missed.">			if (order.getPayment() != null</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">					&amp;&amp; order.getPayment().getPaymentMethod() == com.cg.enumeration.PaymentMethod.CASH_ON_DELIVERY) {</span>
<span class="nc" id="L122">				order.setTransactionStatus(com.cg.enumeration.TransactionStatus.SUCCESS);</span>
			}

			// Release the Agent
<span class="nc bnc" id="L126" title="All 2 branches missed.">			if (order.getDeliveryAgent() != null) {</span>
<span class="nc" id="L127">				DeliveryAgent agent = order.getDeliveryAgent();</span>
<span class="nc" id="L128">				agent.setAvailability(true);</span>
<span class="nc" id="L129">				deliveryAgentRepository.save(agent);</span>
			}

<span class="nc" id="L132">			orderRepository.saveAndFlush(order);</span>
<span class="nc" id="L133">		}</span>

<span class="nc" id="L135">		default -&gt; throw new IllegalStateException(&quot;Invalid status transition from: &quot; + order.getOrderStatus());</span>
		}

		// Re-fetch with payment + agent for a consistent DTO
<span class="fc" id="L139">		Order updated = orderRepository.findByIdWithPaymentAndAgent(orderId)</span>
<span class="pc" id="L140">				.orElseThrow(() -&gt; new RuntimeException(&quot;Order not found after update&quot;));</span>

<span class="fc" id="L142">		return OrderMapper.toDto(updated);</span>
	}

	// GET ONE (Details page)
	@Override
	@Transactional(readOnly = true)
	public OrderDto getById(Long id) throws NotFoundException {
<span class="nc" id="L149">		Order order = orderRepository.findByIdWithPaymentAndAgent(id).orElseThrow(NotFoundException::new);</span>

<span class="nc" id="L151">		OrderDto dto = OrderMapper.toDto(order);</span>

		// Build item details (name -&gt; quantity/price/subtotal)
<span class="nc bnc" id="L154" title="All 4 branches missed.">		if (order.getItems() != null &amp;&amp; !order.getItems().isEmpty()) {</span>
<span class="nc" id="L155">			Map&lt;String, OrderDto.OrderItemDetail&gt; itemDetailsMap = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L156">			Map&lt;String, Integer&gt; itemQuantities = new HashMap&lt;&gt;();</span>
<span class="nc" id="L157">			Map&lt;String, Double&gt; itemPrices = new HashMap&lt;&gt;();</span>

			// Count items by name (duplicates represent quantity)
<span class="nc bnc" id="L160" title="All 2 branches missed.">			for (MenuItem item : order.getItems()) {</span>
<span class="nc" id="L161">				String itemName = item.getItemName();</span>
<span class="nc" id="L162">				itemQuantities.put(itemName, itemQuantities.getOrDefault(itemName, 0) + 1);</span>
				// Store unit price once
<span class="nc" id="L164">				itemPrices.putIfAbsent(itemName, item.getPrice());</span>
<span class="nc" id="L165">			}</span>

			// Build detail map
<span class="nc" id="L168">			itemQuantities.forEach((itemName, qty) -&gt; {</span>
<span class="nc" id="L169">				double unitPrice = itemPrices.get(itemName);</span>
<span class="nc" id="L170">				double subtotal = qty * unitPrice;</span>
<span class="nc" id="L171">				itemDetailsMap.put(itemName, new OrderDto.OrderItemDetail(qty, unitPrice, subtotal));</span>
<span class="nc" id="L172">			});</span>

<span class="nc" id="L174">			dto.setItemDetails(itemDetailsMap);</span>
		}

<span class="nc" id="L177">		return dto;</span>
	}

	// LISTS
	@Override
	@Transactional(readOnly = true)
	public List&lt;OrderDto&gt; getByCustomer(Long customerId) {
<span class="nc" id="L184">		return orderRepository.findByCustomerCustomerId(customerId).stream().map(OrderMapper::toDto)</span>
<span class="nc" id="L185">				.collect(Collectors.toList());</span>
	}

	@Override
	@Transactional(readOnly = true)
	public List&lt;OrderDto&gt; getAll() {
<span class="nc" id="L191">		return orderRepository.findAll().stream().map(OrderMapper::toDto).collect(Collectors.toList());</span>
	}

	@Override
	@Transactional(readOnly = true)
	public List&lt;OrderDto&gt; getOrdersByCustomerEmail(String email) {
<span class="nc" id="L197">		List&lt;Order&gt; orders = orderRepository.findAllByCustomer_EmailOrderByOrderDateDesc(email);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">		List&lt;Order&gt; safe = (orders != null) ? orders : new ArrayList&lt;&gt;();</span>
<span class="nc" id="L199">		return safe.stream().map(OrderMapper::toDto).collect(Collectors.toList());</span>
	}

	// CREATE ORDER
	@Override
	@Transactional
	public OrderDto createOrder(OrderDto newOrderDto) {
<span class="nc" id="L206">		Order order = new Order();</span>
<span class="nc" id="L207">		order.setTotalAmount(newOrderDto.getTotalAmount());</span>
<span class="nc" id="L208">		order.setOrderDate(LocalDateTime.now());</span>
<span class="nc" id="L209">		order.setOrderStatus(OrderStatus.PLACED);</span>

		// Link customer if provided
<span class="nc bnc" id="L212" title="All 2 branches missed.">		if (newOrderDto.getCustomerId() != null) {</span>
<span class="nc" id="L213">			customerRepository.findById(newOrderDto.getCustomerId()).ifPresent(order::setCustomer);</span>
		}

<span class="nc" id="L216">		Order savedOrder = orderRepository.save(order);</span>
<span class="nc" id="L217">		return OrderMapper.toDto(savedOrder);</span>
	}

	// AGENTS
	@Override
	@Transactional(readOnly = true)
	public List&lt;DeliveryAgent&gt; getAvailableAgents() {
<span class="nc" id="L224">		return deliveryAgentRepository.findAllByAvailabilityTrue();</span>
	}

	// OPTIONAL: map helper (kept for compatibility)
	@Override
	public OrderDto map(Order order) {
<span class="nc" id="L230">		OrderDto dto = new OrderDto();</span>
<span class="nc" id="L231">		dto.setOrderId(order.getOrderId());</span>
<span class="nc" id="L232">		dto.setOrderDate(order.getOrderDate());</span>
<span class="nc" id="L233">		dto.setOrderStatus(order.getOrderStatus());</span>
<span class="nc" id="L234">		dto.setTotalAmount(order.getTotalAmount());</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (order.getCustomer() != null) {</span>
<span class="nc" id="L237">			dto.setCustomerId(order.getCustomer().getCustomerId());</span>
		}

<span class="nc bnc" id="L240" title="All 2 branches missed.">		if (order.getItems() != null) {</span>
<span class="nc" id="L241">			dto.setItemIds(order.getItems().stream().map(MenuItem::getItemId).toList());</span>
		}

<span class="nc" id="L244">		Payment payment = order.getPayment();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (payment != null) {</span>
<span class="nc" id="L246">			dto.setPaymentId(payment.getPaymentId());</span>
<span class="nc" id="L247">			dto.setPaymentMethod(payment.getPaymentMethod());</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">			if (payment.getTransactionStatus() != null) {</span>
<span class="nc" id="L249">				dto.setTransactionStatus(payment.getTransactionStatus());</span>
			}
		} else {
<span class="nc" id="L252">			dto.setTransactionStatus(order.getTransactionStatus());</span>
		}

<span class="nc" id="L255">		DeliveryAgent agent = order.getDeliveryAgent();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">		if (agent != null) {</span>
<span class="nc" id="L257">			dto.setDeliveryAgentId(agent.getAgentId());</span>
<span class="nc" id="L258">			dto.setDeliveryAgentName(agent.getAgentName());</span>
<span class="nc" id="L259">			dto.setDeliveryAgentPhone(agent.getContact());</span>
		}

<span class="nc" id="L262">		return dto;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>